<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Black Hook — Games</title>
<style>
  :root{--accent:#ff3030;--text:#f5f5f5;--card:#19191d;--card-border:#2a2a30}
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Arial}
  body{background:#000 url('Cube.gif') center/cover no-repeat fixed;color:var(--text);padding:30px 0}
  body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:0}
  .wrap{position:relative;z-index:2;width:92%;max-width:1100px;margin:0 auto;padding:26px;background:rgba(20,20,22,0.55);backdrop-filter:blur(10px);border-radius:16px;box-shadow:0 0 40px rgba(0,0,0,0.7)}
  h1{text-align:center;margin-bottom:12px;font-size:36px;color:var(--accent)}
  .topbar{text-align:center;margin-bottom:14px}
  .backbtn{display:inline-block;padding:10px 16px;background:#19191d;border:2px solid #2a2a30;color:var(--text);text-decoration:none;border-radius:10px;transition:0.2s;font-size:16px}
  .backbtn:hover{border-color:var(--accent);box-shadow:0 0 16px rgba(255,48,48,0.4)}
  .status{margin:14px 0;padding:10px;border-radius:10px;background:rgba(0,0,0,0.35);color:#ddd;font-size:14px}
  .err{background:rgba(80,0,0,0.45);border:1px solid rgba(255,80,80,0.15);color:#ffd0d0}
  .controls{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:10px 0}
  .controls .search{flex:1;max-width:640px}
  .search input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}
  .game-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:20px;margin-top:18px}
  .game-card{background:var(--card);border-radius:14px;overflow:hidden;border:2px solid var(--card-border);cursor:pointer;text-decoration:none;color:inherit;transform-style:preserve-3d;transition:transform 0.25s ease, box-shadow 0.25s}
  .game-card:hover{transform:rotateX(6deg) rotateY(6deg) scale(1.03);box-shadow:0 20px 40px rgba(0,0,0,0.6),0 0 25px rgba(255,48,48,0.32);border-color:var(--accent)}
  .thumb{width:100%;padding-top:100%;background:#0f1113;position:relative}
  .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
  .info{padding:12px;text-align:center}
  .info .title{font-size:18px;color:var(--accent);font-weight:700}
  .footer-note{margin-top:18px;color:#cfcfcf;font-size:13px;text-align:center}
  @media(max-width:720px){.game-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar"><a class="backbtn" href="index.html">← Back to Home</a></div>
    <h1>Black Hook — Games</h1>

    <div class="controls">
      <div class="search"><input id="search" placeholder="Search games..." aria-label="Search games"></div>
      <div><button id="reload">Reload</button></div>
    </div>

    <div id="status" class="status">Loading games…</div>

    <main>
      <div id="game-grid" class="game-grid" aria-live="polite"></div>
    </main>

    <div class="footer-note">Games are loaded from <code>games.json</code> (or <code>games.csv</code>).</div>
  </div>

<script>
const NO_IMAGE = 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg';
const GRID = document.getElementById('game-grid');
const STATUS = document.getElementById('status');

function setStatus(msg, isError=false){
  STATUS.textContent = msg;
  STATUS.className = 'status' + (isError? ' err':'');
  console.log('STATUS:', msg);
}

// try multiple paths for resilience
async function tryFetchJSONPaths(paths){
  for(const p of paths){
    try{
      const r = await fetch(p, {cache:'no-store'});
      if(!r.ok){
        console.warn('fetch', p, '->', r.status);
        continue;
      }
      const json = await r.json();
      if(Array.isArray(json)) return {src:p, data:json};
      if(json && typeof json.raw === 'string') {
        // wrapper with raw CSV string
        return {src:p, data: parseRaw(json.raw)};
      }
    }catch(e){
      console.warn('error fetching', p, e);
      continue;
    }
  }
  return null;
}

async function tryFetchCSVPaths(paths){
  for(const p of paths){
    try{
      const r = await fetch(p, {cache:'no-store'});
      if(!r.ok) { console.warn('csv fetch', p, '->', r.status); continue; }
      const text = await r.text();
      return {src:p, data: parseRaw(text)};
    }catch(e){ console.warn('csv error', p, e); continue; }
  }
  return null;
}

function parseRaw(raw){
  return raw.split('\\n').map(l=>l.trim()).filter(Boolean).map(line=>{
    const parts = line.split(/,\\s*/);
    const name = parts.shift() || 'Untitled';
    const image = parts.shift() || NO_IMAGE;
    const url = parts.join(',') || '#';
    return {name,image,url};
  });
}

function render(games){
  GRID.innerHTML = '';
  if(!games || !games.length){
    setStatus('No games found in data.', true);
    return;
  }
  setStatus('Loaded ' + games.length + ' games.');
  games.forEach(g=>{
    const a = document.createElement('a');
    a.className = 'game-card';
    a.href = '#';
    a.onclick = (e)=>{ e.preventDefault(); if(g.url && g.url !== '#') location.href = 'viewer.html?site=' + encodeURIComponent(g.url); };

    const thumb = document.createElement('div'); thumb.className = 'thumb';
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.decoding = 'async';
    img.src = g.image || NO_IMAGE;
    img.alt = g.name;
    img.onerror = ()=> img.src = NO_IMAGE;
    thumb.appendChild(img);

    const info = document.createElement('div'); info.className = 'info';
    const title = document.createElement('div'); title.className = 'title'; title.textContent = g.name;
    info.appendChild(title);

    a.appendChild(thumb); a.appendChild(info);
    GRID.appendChild(a);
  });
}

// robust loader
(async function init(){
  setStatus('Trying to load games.json...');
  // try JSON common locations
  const jsonPaths = ['./games.json', 'games.json', './data/games.json', 'data/games.json'];
  const jsonResult = await tryFetchJSONPaths(jsonPaths);
  if(jsonResult){
    console.log('Loaded JSON from', jsonResult.src);
    render(jsonResult.data);
    setupSearch(jsonResult.data);
    return;
  }

  // try CSV fallbacks
  setStatus('games.json not found — trying games.csv...');
  const csvPaths = ['./games.csv','games.csv','./data/games.csv','data/games.csv'];
  const csvResult = await tryFetchCSVPaths(csvPaths);
  if(csvResult){
    console.log('Loaded CSV from', csvResult.src);
    render(csvResult.data);
    setupSearch(csvResult.data);
    return;
  }

  // nothing found
  setStatus('Could not load games.json or games.csv. Make sure the file is in the same folder as this page and is valid JSON/CSV.', true);
})();

function setupSearch(allGames){
  const input = document.getElementById('search');
  input.addEventListener('input', e=>{
    const q = e.target.value.trim().toLowerCase();
    if(!q) { render(allGames); return; }
    const filtered = allGames.filter(g => g.name.toLowerCase().includes(q));
    render(filtered);
  });
}

document.getElementById('reload').addEventListener('click', ()=> location.reload());
</script>
</body>
</html>
